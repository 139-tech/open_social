<?php

use Drupal\Core\Url;

/**
 * Implements hook_form_FORM_ID_alter().
 */
function social_profile_form_profile_profile_add_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  // Remove the save and set default submit button on profile creation.
  if (isset($form['actions']['set_default'])) {
    unset($form['actions']['set_default']);
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function social_profile_form_profile_profile_edit_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  // Remove the save and set default submit button on profile edit.
  if (isset($form['actions']['set_default'])) {
    unset($form['actions']['set_default']);
  }
}

/**
 * Implements hook_local_tasks_alter().
 */
function social_profile_local_tasks_alter(&$local_tasks) {
  // Remove the profile main "Profile information" from the local tabs.
  if (!empty($local_tasks['entity.profile.user_profile_form:profile.type.main'])) {
    unset($local_tasks['entity.profile.user_profile_form:profile.type.main']);
  }
}

/**
 * Return Profile entity by given user id.
 */
function social_profile_load_by_uid($uid) {
  $profile = \Drupal::entityTypeManager()
    ->getStorage('profile')
    ->loadByProperties([
      'uid' => $uid,
      'type' => 'profile',
    ]);

  return reset($profile);
}

/**
 * Implements hook_theme_suggestions_HOOK_alter().
 */
function social_profile_theme_suggestions_profile_alter(array &$suggestions, array $variables) {
  $suggestions = array();
  $profile = $variables['elements']['#profile'];
  $sanitized_view_mode = strtr($variables['elements']['#view_mode'], '.', '_');

  $suggestions[] = 'profile__' . $sanitized_view_mode;
  $suggestions[] = 'profile__' . $profile->bundle();
  $suggestions[] = 'profile__' . $profile->bundle() . '__' . $sanitized_view_mode;

  return $suggestions;
}

/**
 * Implements hook_preprocess_HOOK() for profile.html.twig.
 */
function social_profile_preprocess_profile(array &$variables) {
  $profile = $variables['elements']['#profile'];
  // Username
  $variables['username'] = array(
    '#theme' => 'username',
    '#account' => $profile->getOwner(),
  );
  // Edit profile URL
  $account = \Drupal::currentUser();
  if($profile->access('edit', $account)){
    $variables['edit_url'] = Url::fromUserInput('/user/' . $profile->getOwnerId() . '/edit');
  }
}

/**
 * Implements hook_preprocess_HOOK() for username.html.twig.
 *
 *  Shows profile first + last name if they are available
 */
function social_profile_preprocess_username(&$variables) {
  $account = $variables['account'];
  $profile = social_profile_load_by_uid($account->id());
  if(!empty($profile)){
    $first_name = $profile->get('field_profile_first_name')->getValue();
    $last_name = $profile->get('field_profile_last_name')->getValue();

    if(!empty($first_name && $last_name)){
      //@TODO: Get clean field values in better way.
      $variables['name'] = reset($first_name)['value'] . ' ' . reset($last_name)['value'];
      $variables['name_raw'] = reset($first_name)['value'] . ' ' . reset($last_name)['value'];
    }
  }
}